<!doctype html>
<html class="no-js" lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CHEDDR</title>

  <link rel="stylesheet" href="css/cheddrme.css" />
  <link rel="stylesheet" href="css/foundation.css" />
  <link rel="stylesheet" href="css/foundation-icons.css" />
  <link rel="stylesheet" href="css/toastr.min.css"/>
  <script type="text/javascript" src="js/jquery.js"></script>  
  <script type="text/javascript" src="js/foundation.min.js"></script>
  <script type="text/javascript" src="js/toastr.min.js"></script>
  <script type="text/javascript" src="js/kjua-0.1.1.min.js"></script>
  <script type="text/javascript" src="js/bchaddrjs-0.1.4.js"></script>
  <script type="text/javascript" src="js/cheddrme.js"></script>

  <!--
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.4.3/js/foundation.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kjua@0.1.2/dist/kjua.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
  -->
  
  <script type="text/javascript">
  var paymentAddress = "bitcoincash:qp7zfgk6qfk0dkcf4rd40p7ergrw7fr72v6ed98y4f";
  // legacy = "1CKQgK1f5ZiRwb7DJM7pKKDaJuzE3mTKt8"

  var fiat = "AUD";
  var currentExchangeRate = 0;
  var transFee = 0;

  var transFeeBCH = 0.00000681;
  var transFeeBits = parseFloat(transFeeBCH * 1000000).toFixed(2);

  var subTotal = 0;
  var finalTotal = 0;

  var subTotalBits = 0;
  var finalTotalBits = 0;

  var subTotalBCH = 0;
  var finalTotalBCH = 0;

  toastr.options = {
    "closeButton": true,
    "debug": false,
    "newestOnTop": false,
    "progressBar": false,
    "positionClass": "toast-top-left",
    "preventDuplicates": false,
    "onclick": null,
    "showDuration": "300",
    "hideDuration": "1000",
    "timeOut": "5000",
    "extendedTimeOut": "1000",
    "showEasing": "swing",
    "hideEasing": "linear",
    "showMethod": "fadeIn",
    "hideMethod": "fadeOut"
  }

  $(document).ready(function () {
    $("#paymentSummary").hide();
    $("#displayFiat").text(fiat);
    getExchRate(fiat); 

    var result = 0;
    var prevEntry = 0;
    var operation = null;
    var currentEntry = '0';
    updateScreen(result);

    /* start settings */
    $("#addPaymentAddress").click(function () {
      var Format = bchaddr.Format;
      var Network = bchaddr.Network;
      var Type = bchaddr.Type;
      var isLegacyAddress = bchaddr.isLegacyAddress;
      var isBitpayAddress = bchaddr.isBitpayAddress;
      var isCashAddress = bchaddr.isCashAddress;
      var toCashAddress = bchaddr.toCashAddress;

      var newAddress = $("#inputAddress").val();
      if (newAddress.substring(0,12) === "bitcoincash:") {
              newAddress = newAddress.replace("bitcoincash:",'');
      }
      var validAddress = 0;

      try {
        if (isLegacyAddress(newAddress)) {
            validAddress = 1;
            toastr.warning("Converting Legacy addresss...");
        } 
        if (isBitpayAddress(newAddress)) {
            validAddress = 1;
            toastr.warning("Converting BitPay addresss...");
        } 
        if (isCashAddress(newAddress)) {
            validAddress = 1;
        }
      }
      catch (e) {
              toastr.error("Invalid address");
      }

      if(validAddress === 1) {
        var cashaddr = toCashAddress(newAddress);
        // add bitcoincash: prefix if not found
        if (cashaddr.substring(0,11) != "bitcoincash:") {
          cashaddr = 'bitcoincash:' + cashaddr;
        }

        if (dupeAddress(cashaddr) === 0) {
          $("#myAddresses").append('<div><span class="addedAddress">' + cashaddr + '</span><span>&nbsp;<a href="#" class="removeAddress"><i class="fi-trash"></i></a></span></div>');
          toastr.success("Recieve address added");
        } else {
          toastr.error("This address already exists");
        }
      } 
    });

    $(document).on("click","a.removeAddress", function() {
      $($(this).closest("div")).remove();
      toastr.info("Recieve address removed");
      return false;
    });

    $("select").on("change", function() {
      toastr.info(this.value);
      fiat = this.value;
      $("#displayFiat").text(fiat);
      getExchRate(fiat);
    })
    /* end settings */

    /* start input */
    $("#clearInput").click(function () {
    updateScreen(0);
    });

    $("#addToOrder").click(function () {
    var itemPrice = parseFloat($("#display").val()).toFixed(2);
    var itemPriceBCH = 0;

    if (itemPrice > 0) {
        subTotal = parseFloat(subTotal) + parseFloat(itemPrice);
        finalTotal = parseFloat(subTotal);

        itemPriceBCH = (parseFloat(itemPrice) / parseFloat(currentExchangeRate)).toFixed(10);
        subTotalBCH = parseFloat(subTotalBCH) + parseFloat(itemPriceBCH);
        finalTotalBCH = parseFloat(subTotalBCH);

        itemPriceBits = parseFloat(itemPriceBCH * 1000000).toFixed(2);
        subTotalBits = parseFloat(subTotalBCH * 1000000).toFixed(2);
        finalTotalBits = parseFloat(finalTotalBCH * 1000000).toFixed(2);

        $("#orderedItems").append('<tr class="orderItem"><td><a href="#" class="deleteRow"><i class="fi-trash"></i></a></td><td class="orderPriceFiat">$' + itemPrice + '</td><td class="orderPriceBits">' + thousands(itemPriceBits) + '</td></tr>');
        $("#itemList").scrollTop($("#itemList")[0].scrollHeight);

        updateTotals();
    } 
    });

    $(document).on("click","a.deleteRow", function() {
      $($(this).closest("tr")).remove();
      updateTotals();
      return false;
    });

    $("#orderCheckout").click( function () {
      $("#addToOrder").click();
      if (finalTotal > 0) {
          $("#paymentSummary").show();
          $("#itemList").hide();
          var qrcode = kjua({
          text: paymentAddress,
          ecLevel: 'H',
          size: 256,
          rounded: 100,
          quiet: 0,
          mSize: 26,
          mPosX: 50,
          mPosY: 50
          });
          if ($("#paymentCode").is(':empty')) {
            $("#paymentTitle").empty();
            $("#paymentTitle").append('Please transfer <span class="success label finalTotal">₿' + finalTotalBCH.toFixed(8) + '</span> to:');
            $("#paymentCode").append(qrcode);
            $("#paymentAddress").val(paymentAddress);
          }
        } else {
          toastr.error('No items to checkout');
        }
    });
    /* end input */


    /* start order summary */
    $("#orderCancel").click(function () {
      $("#itemList").show();
      $("#paymentSummary").hide();
      $("#paymentCode").empty();
    });

    $("#orderDone").click(function () {
      location.reload();
    });

    $('.button').on("click", function (evt) {
    var buttonPressed = $(this).html();
    if (buttonPressed === "C") {
        result = 0;
        currentEntry = '0';
    } else if (buttonPressed === "back") {
        //currentEntry = currentEntry.substring(0, currentEntry.length-1);
    } else if (buttonPressed === "+/-") {
        currentEntry *= -1;
    } else if (buttonPressed === '.') {
        currentEntry += '.';
    } else if (isNumber(buttonPressed)) {
        if (currentEntry === '0') currentEntry = buttonPressed;
        else currentEntry = currentEntry + buttonPressed;
    } else {
        currentEntry = '';
    }
    updateScreen(currentEntry);
    });

    $("#copyPaymentAddress").click(function () {
      copyToClipboard(document.getElementById("paymentAddress"));
      toastr.success("Copied to clipboard")
    });
    /* end order summary */
});  
</script>
</head>

<body>
  <br>
  <div class="row align-center medium-unstack medium-8 large-8 text-center">
    <div class="medium-4 large-4 columns callout text-center">

      <h2><i class="fi-bitcoin-circle"> </i>CHEDDR</h2>

      <hr>
      <div class="large-12 medium-12 columns">
        <div class="input-group">
          <span class="input-group-label">$</span>
          <input class="input-group-field" type="text" id="display">
        </div>
      </div>

      <hr>
      <section>
        <div class="expanded button-group">
          <a class="hollow button">7</a>
          <a class="hollow button">8</a>
          <a class="hollow button">9</a>
        </div>

        <div class="expanded button-group">
          <a class="hollow button">4</a>
          <a class="hollow button">5</a>
          <a class="hollow button">6</a>
        </div>

        <div class="expanded button-group">
          <a class="hollow button">1</a>
          <a class="hollow button">2</a>
          <a class="hollow button">3</a>
        </div>

        <div class="expanded button-group">
          <a class="hollow secondary button">.</a>
          <a class="hollow button">0</a>
          <a class="hollow success button" id="addToOrder">
            <i class="fi-plus"></i>
          </a>
        </div>

        <div class="expanded button-group">
          <a class="warning button" id="clearInput">
            <i class="fi-refresh"></i>
          </a>

          <a class="success button" id="orderCheckout">
            <i class="fi-shopping-cart"></i>
          </a>
        </div>
      </section>

      <hr>
    </div>
    <!-- end left card -->


    <!-- payment summary -->
    <div class="large-7 medium-7 columns text-center" id="paymentSummary">
      <div class="callout">
        <h5>Checkout</h5><hr>
        <p id="paymentTitle"></p>
        <div class="input-group">
            <input class="input-group-field" type="text" id="paymentAddress">
            <div class="input-group-button">
                <button id="copyPaymentAddress" data-clipboard-target="#paymentAddress">
                <i class="fi-clipboard"></i>
                </button>
          </div>
        </div>
        <div>
          <p>or scan QR Code:</p>
          <p id="paymentCode"></p>
        </div>
        <div>
            <span id="transactionFee"></span>
            <span class="warning round radius label" id="transFeeRecommended"></span> bits per kilobyte
        </div>
        <hr>
        <div>
          <a class="alert large-2 button" id="orderCancel"><i class="fi-x"></i></a>
          <a class="success large-2 button" id="orderDone"><i class="fi-check"></i></a>
        </div>
      </div>
    </div>
    <!-- end payment summary -->


    <!-- order summary -->
    <div class="large-8 columns" id="itemList" style="height: 31em; overflow-y: auto; overflow-x: hidden;">
      <table width="80%" class="hover">
          <thead>
          <tr>
              <th class="text-center">Item</th>
              <th id="displayFiat" class="text-center"></th>
              <th class="text-center">bits (µBCH)</th>
          </tr>
          </thead>
          <tbody id="orderedItems">
          </tbody>
      </table>
    </div>
    <!-- end order summary -->

    <hr>

    <!-- totals -->
    <div class="large-8 columns">
      <div id="orderTotal">
        <div class="medium-5 large-5 columns">
          <section>
            <h2 class="orderTotal">Total</h2>
          </section>
        </div>
        <div class="medium-3 large-3 columns">
          <section style="padding-top: 15px;">
            <h4 class="orderTotal" id="orderTotalFiat">&nbsp;</h4>
          </section>
        </div>
        <div class="medium-4 large-4 columns">
          <section>
            <h2 class="orderTotal" id="orderTotalBits">&nbsp;</h2>
          </section>
          <section>
            <h4 class="orderTotal" id="orderTotalBCH"></h4>
          </section>
        </div>
      </div>
      </div>
    </div>
    <!-- end totals -->

        <!-- start settings -->
        <div class="medium-6 large-6 columns text-center">
          <div class="callout">
            <h5><i class="fi-widget">&nbsp;</i>Settings</h5>
          
          <hr>
    
          <label>Recieve Addresses
            <div id="myAddresses"></div>
            <div class="input-group">
              <span class="input-group-label">
                <i class="fi-key"></i>
              </span>
              <input id="inputAddress" class="input-group-field" type="text" placeholder="Add recieve address">
            </div>
            <a class="hollow success button" id="addPaymentAddress"><i class="fi-plus"></i></a>
          </label>
          <hr>
  
          <label>Local Currency
            <select>
              <option selected="selected" value="AUD">AUD</option>
                  <option value="BRL">BRL</option>
                  <option value="CAD">CAD</option>
                  <option value="CHF">CHF</option>
                  <option value="CLP">CLP</option>
                  <option value="CNY">CNY</option>
                  <option value="CZK">CZK</option>
                  <option value="DKK">DKK</option>
                  <option value="EUR">EUR</option>
                  <option value="GBP">GBP</option>
                  <option value="HKD">HKD</option>
                  <option value="HUF">HUF</option>
                  <option value="IDR">IDR</option>
                  <option value="ILS">ILS</option>
                  <option value="INR">INR</option>
                  <option value="JPY">JPY</option>
                  <option value="KRW">KRW</option>
                  <option value="MXN">MXN</option>
                  <option value="MYR">MYR</option>
                  <option value="NOK">NOK</option>
                  <option value="NZD">NZD</option>
                  <option value="PHP">PHP</option>
                  <option value="PKR">PKR</option>
                  <option value="PLN">PLN</option>
                  <option value="USD">USD</option>
                  <option value="RUB">RUB</option>
                  <option value="SEK">SEK</option>
                  <option value="SGD">SGD</option>
                  <option value="THB">THB</option>
                  <option value="TRY">TRY</option>
                  <option value="TWD">TWD</option>
                  <option value="ZAR">ZAR</option>
            </select>
          </label>   
          <hr>

          <a class="hollow warning button" id="cancelSettings"><i class="fi-prohibited"></i></a>
          <a class="hollow success button" id="saveSettings"><i class="fi-check"></i></a>

          </div>
        </div>
        <!-- end settings -->  

    <!-- start footer -->
    <div class="medium-12 large-12 columns text-center">
      
    </div>
    <!-- end footer --> 

</body>

</html>